<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../stylesheet/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,300;1,400;1,500;1,700&family=Montserrat:ital,wght@0,300;0,500;0,700;1,300;1,500;1,700&display=swap"
        rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,300;1,400;1,500;1,700&family=Montserrat:ital,wght@0,700;1,500;1,700&display=swap"
        rel="stylesheet">
    <title>Add to Cart</title>
    <style>
        header {
            position: relative;
        }
        /* CSS để trang web trở nên đẹp hơn */
        .container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin: 20px;
        }

        .product {
            border: 1px solid #ccc;
            padding: 10px;
            margin-right: 20px;
        }

        .cart {
            border: 1px solid #ccc;
            padding: 10px;
            width: 200px;
        }

        .cart-item {
            margin-bottom: 10px;
        }

        .product-img {
            max-width: 100%;
            /* Đặt kích thước tối đa của hình ảnh là 100% của phần tử cha */
            height: 200px;
            /* Giữ tỷ lệ khung hình khi thay đổi kích thước */
        }

        #productsContainer {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            gap: 20px;
            padding: 20px 0;
        }

        .product {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #ccc;
            padding: 15px;
            width: calc(33.33% - 40px);
            /* Chiếm 1/3 chiều rộng của container trừ đi khoảng cách */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .product:hover {
            transform: translateY(-5px);
        }

        .product h2 {
            margin: 10px 0;
            font-size: 18px;
            color: #333;
        }

        .product p {
            font-size: 14px;
            color: #666;
        }

        .product img {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
        }

        .product button {
            padding: 10px 20px;
            background-color: #0056b3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .product button:hover {
            background-color: #004494;
        }

        .cart {
            width: 350px;
            padding: 20px;
            border: 1px solid #ccc;
            position: fixed;
            /* Giúp giỏ hàng luôn hiển thị mặc dù kéo trang */
            right: 20px;
            top: 100px;
            background: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .cart h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ccc;
        }

        .cart-item p {
            margin: 0;
            font-size: 14px;
            color: #555;
        }

        .cart-item button {
            padding: 5px 10px;
            background-color: #ff0000;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .cart-item button:hover {
            background-color: #cc0000;
        }

        #totalPrice {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .cart button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        .cart button:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>
    <header>
        <ul id="left-menu">
            <li><a href="" class="kfc">ve kfc</a><img
                    src="https://images.foody.vn/res/g1/4093/prof/s640x400/image-19f75773-220812162155.jpg" alt=""></li>
            <li><a href="">thuc don</a><img src="img/D7.jpg" alt=""></li>
            <li><a href="">khuyen mai</a><img src="img/D6.jpg" alt=""></li>
            <li><a href="">he thong</a><img src="img/D8.jpg" alt=""></li>
        </ul>
        <div class="logogiua">
            <img src="img/kfc.png" alt="">
        </div>
        <div id="wrapper">
            <div id="main-menu">
                <a href="#"><img src="../images/logo_kfc.jpg" alt="#" id="logo"></a>
                <ul>
                    <li><a href="./datngay.html">Giỏ hàng</a></li>
                    <li><a href="">Search Menu</a></li>
                    <!-- <li><a href="">Giỏ hàng</a></li> -->
                </ul>
            </div>
            <div id="menu-login">
                <ul>
                    <a href=""><i class="fa-solid fa-circle-user"></i></i></a>
                </ul>
                <div class="logo-phone"><img
                        src="https://e7.pngegg.com/pngimages/108/760/png-clipart-kfc-logo-kfc-logo-fast-food-restaurant-chicken-meat-kfc-miscellaneous-food-thumbnail.png"
                        alt=""></div>
                <a href="">
                </a>
            </div>

        </div>
    </header>

    <div class="container" id="productsContainer">
        <!-- Danh sách sản phẩm sẽ được thêm vào đây -->
    </div>

    <!-- Giỏ hàng -->
    <div class="cart">
        <h2>Giỏ hàng</h2>
        <div id="cartItems">
            <!-- Danh sách sản phẩm trong giỏ hàng sẽ được thêm vào đây -->
        </div>
        <p>Tổng tiền: $<span id="totalPrice">0.00</span></p>
        <button onclick="checkout()">Thanh toán</button>
    </div>

    <script>
        let cartItems = [];

        // Gọi router để lấy thông tin giỏ hàng từ server khi trang index được load
        window.addEventListener('load', () => {
            // Lấy thông tin sản phẩm từ API
            fetch('/api/products')
                .then(response => response.json())
                .then(products => {
                    // Sau khi nhận được danh sách sản phẩm, cập nhật giao diện người dùng
                    displayProducts(products);

                    // Lấy thông tin giỏ hàng sau khi đã lấy thông tin sản phẩm
                    const userId = 'user123'; // Thay thế bằng userId thực tế
                    fetch(`/api/cart/${userId}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                            data.forEach(item => {
                                cartItems.push({
                                    productId: item.productId, // Lưu ý: productId được sử dụng như id của sản phẩm trong giỏ hàng
                                    productName: item.name,
                                    productPrice: item.price // Sử dụng giá trị số đã chuyển đổi
                                });
                            });
                            displayCartItems();
                        })
                        .catch(error => console.error('Lỗi khi lấy thông tin giỏ hàng:', error));
                })
                .catch(error => console.error('Lỗi khi lấy thông tin sản phẩm:', error));
        });

        function displayProducts(products) {
            const productsContainer = document.getElementById('productsContainer');

            // Xóa các sản phẩm cũ (nếu có)
            productsContainer.innerHTML = '';

            // Loop qua mỗi sản phẩm và hiển thị nó trên trang
            products.forEach(product => {
                // Tạo đường dẫn hình ảnh
                const productImgUrl = `../images/${product.productImg}`;
                console.log(productImgUrl);

                const productElement = document.createElement('div');
                productElement.classList.add('product');
                productElement.innerHTML = `
            <h2>${product.productName}</h2>
            <p>ID: <span>${product.productId}</span></p>
            <p>Giá: $<span>${product.productPrice}</span></p>
            <img src="${productImgUrl}" alt="${product.productImg}" class="product-img"><br><br>
            <button onclick="addToCart('${product.productId}', '${product.productName}', '${product.productPrice}')">Thêm vào giỏ hàng</button>
        `;
                productsContainer.appendChild(productElement);
            });
        }

        function addToCart(productId, productName, productPrice) {
            fetch('/add-to-cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userId: 'user123', // Thay thế bằng userId thực tế
                    productId: productId,
                    productName: productName,
                    productPrice: productPrice
                }),
            })
                .then(response => response.text())
                .then(data => {
                    alert(data);
                    // Sau khi thêm sản phẩm vào giỏ hàng thành công, thêm sản phẩm vào mảng cartItems
                    cartItems.push({
                        productId: productId,
                        productName: productName,
                        productPrice: productPrice
                    });
                    // Gọi hàm displayCartItems để cập nhật giao diện giỏ hàng
                    displayCartItems();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }


        function displayCartItems() {
            const cartContainer = document.getElementById('cartItems');
            const totalPriceElement = document.getElementById('totalPrice');
            cartContainer.innerHTML = '';

            let totalPrice = 0;

            cartItems.forEach(item => {
                const cartItemElement = document.createElement('div');
                cartItemElement.classList.add('cart-item');

                // Kiểm tra xem productPrice có phải là một chuỗi không
                if (typeof item.productPrice === 'string') {
                    // Chuyển đổi productPrice thành số
                    const price = parseFloat(item.productPrice);

                    if (!isNaN(price)) {
                        cartItemElement.innerHTML = `
                    <p>${item.productName} - $${price.toFixed(2)}</p>
                    <button onclick="removeFromCart('${item.productId}')">Xóa</button>
                `;
                        cartContainer.appendChild(cartItemElement);
                        // Cộng tổng giá tiền
                        totalPrice += price;
                    } else {
                        console.error('Error: Invalid product price');
                    }
                } else {
                    console.error('Error: Product price is not a string');
                }
            });

            // Hiển thị tổng giá tiền
            totalPriceElement.textContent = totalPrice.toFixed(2);
        }




        // Function to remove item from cart
        // Hàm này xóa sản phẩm có ID cụ thể khỏi giỏ hàng trên giao diện người dùng
        // Function to remove item from cart
        function removeFromCart(productId) {
            console.log(productId);
            // Cập nhật mảng cartItems bằng cách loại bỏ sản phẩm có productId khớp
            cartItems = cartItems.filter(item => item.productId !== productId);

            // Gọi hàm displayCartItems để cập nhật hiển thị giỏ hàng
            displayCartItems();

            // Gửi yêu cầu tới server để xóa sản phẩm khỏi giỏ hàng trong cơ sở dữ liệu
            fetch(`/remove-from-cart/${'user123'}/${productId}`, {
                method: 'DELETE'
            })
                .then(response => response.text())
                .then(message => {
                    console.log(message);  // In thông điệp phản hồi từ server
                })
                .catch(error => {
                    console.error('Error:', error);  // Báo lỗi nếu có
                });
        }


        function checkout() {
            window.location.href = './pay.html';
        }

    </script>

</body>

</html>